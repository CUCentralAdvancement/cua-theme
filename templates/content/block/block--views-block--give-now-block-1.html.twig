{#
/**
 * @file
 * Template for the Give Now blocks.
 */
#}

{{ attach_library('cua_theme/call-to-action') }}

{# Import macros for reusable template logic. #}
{% import '@cua_theme/component/macros/card_title.html.twig' as titleMacros %}

{% set lead_classes = [
	'view',
	'view-' ~ id|clean_class,
	'view-id-' ~ id,
	'view-display-id-' ~ display_id,
	dom_id ? 'js-view-dom-id-' ~ dom_id,
	'give-now-block',
	'card rounded-0',
	'py-3',
] %}

{# Define classes for the flag container dynamically #}
{% set flag_classes = [
	'flag',
	'py-2',
	flag_background ?: '',
] | filter(v => v) %}

{# Editing tools #}
{% if user.hasPermission('administer site configuration') %}
	<div class="col m-2">
		<a href="/give-now/sort" class="btn btn-primary">Sort and manage give
			now</a>
		<a href="/node/add/gi" class="btn btn-primary">Add new give
			now</a>
	</div>
{% endif %}

{# Render Content #}
{% if content['#view'] is not empty %}
	{% set view = content['#view'] %}
	{% if view.result is not empty %}

		<div class="container-fluid bg-gray-20 py-3">
			<div class="row">
				{% for row in view.result %}
					{% if row._entity is not empty %}
						{% set node = row._entity %}

						{# Get field values safely #}
						{% set flag = node.field_flag.value %}
						{% set flag_background = node.field_flag_background.value %}
						{% set flag_title = node.field_flag_title.value %}
						{% set icon = node.field_icon.value %}
						{% set icon_color = node.field_icon_color.value %}
						{% set icon_size = node.field_icon_size.value %}

						{# Define flag container classes dynamically #}
						{% set flag_classes = [
							'flag',
							'py-2',
							flag_background ?: '',
						] | filter(v => v) %}

						<div class="give-now-item col-12 col-md-6 col-lg-3">
							<div class="m-2 h-100 {{ shadow }} {{ flag_background }}">
								<a href="{{ node.field_link.uri ?? '#' }}" class="text-decoration-none" aria-label="Read {{ node.label }}">

									{# Render Flag and Icon #}
									<div class="position-relative">
										<div class="position-absolute start-0">
											<div class="{{ flag_classes|join(' ')|trim }}"
												 aria-hidden="true"
												 style="visibility: visible; min-width: 150px; display: flex; align-items: center; justify-content: flex-start; padding: 5px 10px;">

												{# Render Icon #}
												{% if icon %}
													<i class="{{ icon }} {{ icon_size }} px-1" style="color: {{ icon_color }}"></i>
												{% endif %}

												{# Render Flag Title #}
												<span class="flag-title">{{ flag_title }}</span>

											</div>
										</div>

										{# Render Image #}
										{% if node.field_image.entity.uri.value is not empty %}
											<div class="card-header mb-2">
												<img src="{{ file_url(node.field_image.entity.uri.value) }}" alt="{{ node.field_image.alt }}" class="img-fluid">
											</div>
										{% endif %}
									</div>

									<div class="px-3 pt-2">
										<h3 class="give-now-title {{ color_text }}">{{ node.label }}</h3>

										{% if node.body.value is not empty %}
											<div class="give-now-body {{ color_text }} mb-2">
												{{ node.body.value|raw }}
											</div>
										{% endif %}

										<div class="card-footer card-story d-flex p-0 mb-5">
							<span class="card-link btn outline-btn-cu-bg-black text-decoration-none p-2 mt-3">
								{{ node.field_link.title ?: node.label }}
							</span>
										</div>
									</div>
								</a>
							</div>
						</div>

					{% endif %}
				{% endfor %}
			</div>
		</div>
	{% else %}
		<p class="no-content-message text-black">No content available.</p>
	{% endif %}
{% else %}
	<p class="no-view-message text-black">View data not available.</p>
{% endif %}
