{#
/**
 * @file
 * Template for the Lead Story blocks.
 */
#}

{{ attach_library('cua_theme/call-to-action') }}

{% set leadstory_classes = [
    'block',
    'block-' ~ configuration.provider|clean_class,
    'block-' ~ plugin_id|clean_class,
    'm-2',
    'h-100',
    'stories-item',
    id ? 'block--class--stories-' ~ id|clean_class : null,
] | merge(utility_classes ?: []) | filter(v => v) | join(' ') %}

{% if user.hasPermission('administer site configuration') %}
    <div class="col d-flex justify-content-center mt-2">
        <a href="/lead-story/sort" class="btn btn-primary" target="_blank" rel="noopener noreferrer">{{ 'Sort and manage lead'|t }}</a>
        <a href="/node/add/lead_story" class="btn btn-primary" target="_blank" rel="noopener noreferrer">{{ 'Add new lead story'|t }}</a>
        <a href="/impact-stories" class="btn btn-primary" target="_blank" rel="noopener noreferrer">{{ 'View all lead stories'|t }}</a>
    </div>
{% endif %}

{% if content['#view'] is not empty %}
    {% set view = content['#view'] %}
    {% if view.result is not empty %}
        <div class="container-fluid cu-bd-black pt-3 pb-5 px-2">
            {# Responsive layout: 1 col on mobile, 2 on tablet, 4 on desktop #}
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-4">

                {% for row in view.result %}
                    {% if row._entity is not empty %}
                        {% set node = row._entity %}
                        {% if node.field_link is not empty and node.field_link.uri is not empty %}
                            <div class="d-flex">
                                <a href="{{ node.field_link.uri }}"
                                   class="{{ leadstory_classes }}"
                                   id="stories-item-{{ node.id }}"
                                   aria-labelledby="story-title-{{ node.id }}"
                                   style="text-decoration: none; color: inherit; display: block; width: 100%;">

                                    <div class="lead-story-wrapper p-2">

                                        {% if node.field_image.entity %}
                                            {% set image_url = node.field_image.entity.fileuri | image_style('lead_story') %}
                                            {% set alt_text = node.field_image.alt ?? 'Image for ' ~ node.label %}
                                            <div class="card-header mb-2">
                                                <img src="{{ image_url }}"
                                                     alt="{{ alt_text|e('html_attr') }}"
                                                     class="img-fluid">
                                            </div>
                                        {% endif %}

                                        <div class="stories-content pt-2">
                                            <h3 class="stories-title" id="story-title-{{ node.id }}">
                                                {{ node.label }}
                                            </h3>

                                            {% if node.body.value is not empty %}
                                                <div class="stories-body mb-2">
                                                    {{ node.body.value|striptags('<p><br><strong><em><ul><ol><li><a>')|raw }}
                                                </div>
                                            {% endif %}

                                            {% if node.field_link.title or node.label %}
                                                <div class="card-footer card-story d-flex p-0 mb-5">
                          <span class="card-link btn outline-btn-cu-bg-light-grey text-decoration-none p-2 mt-3 text-white">
                            {{ node.field_link.title ?? 'Read more' }}
                          </span>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </a>
                            </div>
                        {% endif %}
                    {% endif %}
                {% endfor %}

            </div>
        </div>
    {% else %}
        <div class="text-center p-4">
            <p class="no-content-message text-muted">{{ 'No stories available at the moment. Check back soon!'|t }}</p>
        </div>
    {% endif %}
{% else %}
    <p class="no-view-message text-black">{{ 'View data not available.'|t }}</p>
{% endif %}