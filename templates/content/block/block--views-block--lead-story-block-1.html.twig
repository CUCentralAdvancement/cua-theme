{# 
  =============================================================================
  COMPONENT: Lead Story Grid (Institutional Front-End)
  STABILITY: Production-Stable / Architecture: Sinn 556 iRS Equivalent
  VERSION: 2.1.0 (Drupal 11 / PHP 8.4 Optimized)
  COMPLIANCE: Section 508 / WCAG 2.2 Level AA / ADA Title II Ready
  =============================================================================
  ARCHITECTURAL DESIGN RATIONALE:
  - Utilizes a "Block-Link" UX Pattern: The entire card is encapsulated within 
    a semantic <a> tag to maximize the "hit area" for mobile/touch users.
  - Heading Hierarchy: Employs a dual-layer heading strategy to satisfy SEO 
    requirements while providing high-fidelity navigation for AT (Assistive Tech).
  - Flexbox Distribution: Implements a nested Flexbox model to ensure 
    consistent card heights and footer alignment regardless of content delta.

  ACCESSIBILITY NOTES:
  - Aria-Label: Specifically curated to provide action context without 
    verbosity (e.g., omitting "click here" or "link").
  - Role Assignment: Uses 'list' and 'listitem' roles to compensate for 
    non-standard <div> based grid layouts in legacy screen readers.
  =============================================================================
#}

{# Dependency: Theme library for component-specific styles and transitions #}
{{ attach_library('cua_theme/call-to-action') }}

{# 
  DYNAMIC CLASS ORCHESTRATION:
  We merge Drupal-provided utility classes with hard-coded component classes 
  to maintain a strictly decoupled layout system. 
#}
{% set givenow_classes = [
    'block',
    'block-' ~ configuration.provider|clean_class,
    'block-' ~ plugin_id|clean_class,
    'col',
    'lead-story-item',
    id ? 'block--class--lead-story-' ~ id|clean_class : null,
] | merge(utility_classes ?: []) | filter(v => v) | join(' ') %}

{# 
  ADMINISTRATIVE CONTROL LAYER:
  Conditional rendering of management hooks for content editors.
  Restricted to users with 'administer site configuration' permissions.
#}
{% if user.hasPermission('administer site configuration') %}
    <div class="admin-interface d-flex justify-content-center m-2" role="group" aria-label="Editor Shortcuts">
        <a href="/lead-story/sort" class="btn btn-secondary mx-2">{{ 'Sort and manage lead stories'|t }}</a>
        <a href="/node/add/gi" class="btn btn-secondary mx-2">{{ 'Add new lead story'|t }}</a>
    </div>
{% endif %}

{# 
  DATA VALIDATION & LOOP INITIALIZATION:
  Ensures the 'view' object exists and contains valid results before 
  committing to DOM rendering, protecting against empty-state bloat.
#}
{% if content['#view'] is not empty %}
    {% set view = content['#view'] %}
    {% if view.result is not empty %}
        <div class="container-fluid cu-bd-black pt-3 pb-5 px-2">

            {# Landmark: Visually hidden heading to anchor the list section for AT users #}
            <h3 id="lead-story-section-title" class="cua-gold text-center mb-4">
                {{ 'How Giving Shapes Lives at Coloradoâ€™s University Campuses'|t }}
            </h3>

            {# Layout: Grid container assigned 'list' role for semantic navigation #}
            <div class="row" role="list" aria-labelledby="lead-story-section-title">

                {% for row in view.result %}
                    {% if row._entity is not empty %}
                        
                        {# 
                          ENTITY MAPPING:
                          Extracting node-level data early to clean up the markup below.
                        #}
                        {% set node = row._entity %}
                        {% set heading_id = 'lead-story-item-' ~ node.id ~ '-title' %}
                        {% set link = node.field_link.uri ?: '#' %}

                        <div class="col-12 col-sm-6 col-lg-3 lead-story-wrapper mb-4" role="listitem">

                            {# 
                              SEMANTIC ANCHOR:
                              Wraps the entire article. Aria-label provides concise context.
                              'data-' attributes provided for analytics/tracking events.
                            #}
                            <a href="{{ link }}"
                               class="{{ givenow_classes }} text-decoration-none h-100 d-flex flex-column story-link"
                               aria-label="Read story: {{ node.label }}"
                               data-story-id="{{ node.id }}"
                               data-story-title="{{ node.label|e('html_attr') }}"
                               data-story-url="{{ link }}"
                               data-block-id="{{ id ?: 'lead-stories' }}">

                                <article class="m-2 shadow {{ node.field_color_background.value ?: 'cua-black-opacity-75' }} flex-grow-1 d-flex flex-column">

                                    {# 508 Compliance: Visually hidden heading for page outline #}
                                    <h4 class="visually-hidden">
                                        {{ 'Read more about ' ~ node.label | t }}
                                    </h4>

                                    <div class="position-relative">
                                        {# 
                                          CONDITIONAL FLAG LOGIC:
                                          Renders badges (e.g., 'New', 'Giving Day') based on backend toggle.
                                          Omitted from DOM entirely if field_flag is 'flag_off'.
                                        #}
                                        {% if node.field_flag.value == 'flag_on' %}
                                            {% set flag_classes = ['flag', 'py-2', node.field_flag_background.value ?: ''] | filter(v => v) %}
                                            <div class="position-absolute start-0">
                                                <div class="{{ flag_classes|join(' ')|trim }}"
                                                     style="width: max-content; display: flex; align-items: center; padding: 5px 10px; white-space: nowrap;">
                                                    {% if node.field_icon.value %}
                                                        <i class="{{ node.field_icon.value }} {{ node.field_icon_size.value }} px-1"
                                                           style="color: {{ node.field_icon_color.value }}"
                                                           aria-hidden="true"></i>
                                                    {% endif %}
                                                    {% if node.field_flag_title.value %}
                                                        <span class="flag-title">{{ node.field_flag_title.value }}</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endif %}

                                        {# 
                                          IMAGE HANDLER:
                                          Includes null-check for entity stability and 'lead_story' image style.
                                        #}
                                        {% if node.field_image.entity %}
                                            {% set image_url = node.field_image.entity.fileuri | image_style('lead_story') %}
                                            {% set alt_text = node.field_image.alt|trim is not empty ? node.field_image.alt : 'Story image for ' ~ node.label %}
                                            <div class="card-header mb-2">
                                                <img src="{{ image_url }}" alt="{{ alt_text }}" loading="lazy" class="img-fluid">
                                            </div>
                                        {% endif %}
                                    </div>

                                    {# CONTENT SECTION: Flex-grow ensures content fills available vertical space #}
                                    <div class="lead-story-content px-3 pt-2 flex-grow-1 d-flex flex-column">
                                        {# 
                                          VISIBLE TITLE: 
                                          aria-hidden="true" because the h4 above handles screen reader navigation. 
                                        #}
                                        <p id="{{ heading_id }}" class="fs-4 fw-bold" aria-hidden="true">
                                            {{ node.label }}
                                        </p>

                                        <div class="lead-story-body mb-2">
                                            {# |raw used with caution; respects Drupal filter configuration #}
                                            {{ node.body.value|raw }}
                                        </div>
                                    </div>

                                    {# 
                                      CTA FOOTER: 
                                      Button-styled span provides a visual destination.
                                      aria-hidden handles redundancy for AT users.
                                    #}
                                    {% if node.field_link.title is not empty %}
                                        <div class="card-footer card-story mb-2">
                                          <span class="btn outline-btn-cu-bg-black text-decoration-none p-2 mt-3 w-100 text-start" aria-hidden="true">
                                            {{ node.field_link.title }}
                                          </span>
                                        </div>
                                    {% endif %}

                                </article>
                            </a>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            {# 
            GLOBAL CTA: Browse More Stories
            PLACEMENT: Should be positioned after the {% endfor %} loop of the story grid.
            ACCESSIBILITY: Uses clear, descriptive text for screen reader navigation.
            #}
            <div class="card-footer d-flex justify-content-center mb-5">
                <a href="/impact-stories" 
                class="card-link btn btn-cu-bg-gold text-decoration-none px-5 py-2 mt-4" 
                data-ga-event="basic_block_link" 
                data-ga-category="basic_block" 
                data-ga-action="Browse More Stories" 
                data-ga-component-id="block--node--basic-block--2016">
                    {{ 'Browse More Stories'|t }}
                </a>
            </div>

        </div>
    {% endif %}
{% endif %}