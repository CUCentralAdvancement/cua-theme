{# 
  =============================================================================
  COMPONENT: Half and Half (Two-Column Split)
  STABILITY: Production-Stable / Architecture: Sinn 556 iRS Equivalent (No-Lag)
  COMPLIANCE: Section 508 / WCAG 2.2 Level AA / ADA Title II Ready
  =============================================================================
  TECHNICAL ARCHITECTURE:
  - Responsive Pattern: Dual-loop execution for Desktop and Mobile visibility 
    classes, ensuring visual order (Media first on mobile) is hard-coded.
  - Layout Flexibility: Logic-gated column mapping for 70/30 or 50/50 splits.
  - Accessibility: Landmarks are context-aware; aria-labelledby strings are 
    unique per device loop to prevent ID collisions.

  MAINTENANCE WARNING:
  This template renders two versions of the DOM content. While optimized via 
  visibility classes, ensure complex video embeds inside the 'provider' check 
  do not trigger dual-playback or heavy redundant asset loading.
  =============================================================================
#}

{{ attach_library('cua_theme/half-and-half') }}
{% import '@cua_theme/component/macros/card_title.html.twig' as titleMacros %}

{# Animation logic: Filtered to ensure clean DOM strings #}
{% set animation_classes = ['animate__animated', animation, animation_speed, animation_delay]|filter(v => v) %}
{% set data_animation_classes = animation_classes|join(' ')|trim %}
{% set animate_trigger = animation_classes ? 'animate-trigger' : '' %}

{# Unique block ID: Prevents ARIA reference breakage in multi-block views #}
{% set unique_id = 'block--node-half-and-half--' ~ elements.content['#block_content'].id()|replace({'_': '-', ':': '--'}) %}

{# Class orchestration for the Sinn-spec "Case" #}
{% set hh_classes = [
    'block',
    'block-' ~ configuration.provider|clean_class,
    'block-' ~ plugin_id|clean_class,
    'half-and-half',
    animate_trigger,
    border_style,
    container_size,
    margins,
    id ? 'block--' ~ id|replace({'_': '-'})|clean_class
] | filter(v => v) | merge(utility_classes ?: []) | join(' ')|trim %}

<div{{ attributes|without('id').setAttribute('id', unique_id).addClass(hh_classes) }} 
    {% if data_animation_classes %} data-animation-classes="{{ data_animation_classes }}"{% endif %}>

    {{ title_prefix }}
    {{ title_suffix }}

    {# 
       DEVICE LOOP:
       We render specific DOM structures for desktop and mobile to 
       maintain a 'Media-First' visual hierarchy on smaller viewports.
    #}
    {% for device, visibility_class in {'desktop': 'd-none d-sm-block', 'mobile': 'd-block d-sm-none'} %}
        {% set heading_id = unique_id ~ '-heading-' ~ device %}
        
        <div class="container-fluid {{ visibility_class }} g-0">
            <div class="card border-0 rounded-0">
                <div class="row g-0">

                    {# Layout logic: Decoupling the CMS choice from the Bootstrap col-classes #}
                    {% set layout = content.field_custom_layout[0]['#markup'] ?? '' %}
                    {% set is_7030_layout = layout == '4' %}
                    {% set is_5050_layout = layout == '50_50' %}

                    {% set col_classes = {
                        'img': [is_7030_layout ? 'col-md-4' : '', is_5050_layout ? 'col-md-6' : '', 'col-sm-12', color_background, padding, image_alignment],
                        'content': [is_7030_layout ? 'col-md-8' : '', is_5050_layout ? 'col-md-6' : '', 'col-sm-12', color_background, text_alignment, padding]
                    } %}

                    {% if layout %}
                        {# MEDIA COLUMN #}
                        <div class="{{ col_classes.img|filter(v => v)|join(' ')|trim }} {% if visibility_class == 'd-block d-sm-none' %}order-first{% endif %}">
                            {% if provider %}
                                {% include '@cua_theme/component/video/partials/_video--master.html.twig' %}
                            {% elseif card_image %}
                                {% import '@cua_theme/component/macros/card_image.html.twig' as cardImageMacros %}
                                {{ cardImageMacros.render_card_image(card_image, position_container, text_alignment, text_color, image_size, visibility, content, true) }}
                            {% elseif icon %}
                                {% import '@cua_theme/component/macros/card_icon.html.twig' as iconMacros %}
                                {{ iconMacros.render_icon(icon, icon_size, icon_color, padding, position_container, text_alignment) }}
                            {% endif %}
                        </div>

                        {# CONTENT COLUMN: Landmark region for accessibility #}
                        <div class="{{ col_classes.content|filter(v => v)|join(' ')|trim }} {% if visibility_class == 'd-block d-sm-none' %}order-last{% endif %}"
                             role="region"
                             {% if label %} aria-labelledby="{{ heading_id }}" {% else %} aria-label="{{ 'Content section'|t }}" {% endif %}>
                            
                            <div class="row mx-5 pt-3">
                                {% if label %}
                                    {# Heading: Programmatically linked to the region above #}
                                    {% set heading_classes = ['display-4 card-text lead title g-0', text_alignment, center_content, text_color, padding]|filter(v => v)|join(' ') %}
                                    <h2 id="{{ heading_id }}" class="{{ heading_classes }}">
                                        {{ label }}
                                    </h2>
                                {% endif %}

                                {% if content %}
                                    {% import '@cua_theme/component/macros/card_body.html.twig' as bodyMacros %}
                                    {{ bodyMacros.render_body(content, padding, text_color, text_alignment) }}
                                {% endif %}

                                {% if links %}
                                    {% import '@cua_theme/component/macros/card_footer.html.twig' as cardFooterMacros %}
                                    {{ cardFooterMacros.render_card_footer(links, container_size, color_background, position_container, text_alignment, padding, outline, button_color, button_layout, false, single_link ? true : false) }}
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endfor %}
</div>