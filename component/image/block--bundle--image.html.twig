{# 
  =============================================================================
  COMPONENT: Image Bundle (Visual-First Card)
  STABILITY: Production-Stable / Architecture: Sinn 556 iRS Equivalent (No-Lag)
  COMPLIANCE: Section 508 / WCAG 2.2 Level AA / Schema.org 'CreativeWork'
  =============================================================================
  TECHNICAL ARCHITECTURE:
  - UX Logic: "Smart-Wrapper" pattern turns the entire card into a click-target 
    if a single CTA is present, improving Fitts's Law hit-consistency.
  - A11Y: Robust aria-label synthesis prevents the "redundant link" problem by 
    merging the card context with the CTA text.
  - Tracking: Explicit data-ga-action mapping for granular heatmapping.

  MAINTENANCE WARNING:
  The wrapper uses 'd-block text-reset' to ensure that even when the card is 
  an <a> tag, it maintains the look of a static container. Verification of 
  hover-states in cua_theme/image-bundle CSS is recommended.
  =============================================================================
#}

{# Asset Load: Selective library injection #}
{{ attach_library('cua_theme/image-bundle') }}

{# 
  ID ARCHITECTURE:
  Derived from the Block Content ID with fallback logic. This is critical for 
  ensuring that GA4 component-ids remain stable across environment deployments.
#}
{% set block_entity = elements.content['#block_content'] ?? null %}
{% if block_entity is not null and block_entity.id is defined %}
    {% set unique_id = 'image-bundle-' ~ block_entity.id()|replace({'_': '-', ':': '--'}) %}
{% else %}
    {% set unique_id = id ? 'image-bundle-' ~ id|replace({'_': '-'})|clean_class : 'image-bundle-static' %}
{% endif %}

{# ROBUST TITLE: Extraction for A11Y labels, regardless of "Display Title" status #}
{% set component_title = label ?: (block_entity ? block_entity.label() : null) %}

{# Class orchestration for the Sinn-spec "Case" #}
{% set image_bundle_classes = [
    'block image-bundle card rounded-0',
    'block-' ~ (configuration.provider|default('')|clean_class),
    color_background ?: null,
    color_border ?: null,
    container_size ?: null,
    text_alignment ?: null,
    margins ?: null,
    id ? 'block--' ~ id|replace({'_': '-'})|clean_class : null
] | merge(utility_classes ?: []) | filter(v => v) | join(' ') %}

{# Link Logic: Multi-paradigm detection #}
{% set links = links ?: [] %}
{% set links_count = links is iterable ? links|length : 0 %}
{% if links_count == 1 %}
    {% set first_key = links|keys|first %}
    {% set single_link = first_key is not null ? links[first_key] : (links|first) %}
{% else %}
    {% set single_link = null %}
{% endif %}
{% set wrap_entire_card = single_link is not null %}

{# OUTER WRAPPER: Marked as 'CreativeWork' for Google's rich snippets #}
<div{{ attributes
    .without('id')
    .setAttribute('id', unique_id)
    .addClass(image_bundle_classes)
    .setAttribute('role', 'region')
    .setAttribute('itemscope', '')
    .setAttribute('itemtype', 'https://schema.org/CreativeWork')
    .setAttribute('data-component', 'image-bundle-card')
}}>

    {{ title_prefix }}
    {{ title_suffix }}

    {# 
       SMART WRAPPER: 
       If the card wraps, we build a "Hyper-Label" for accessibility.
    #}
    {% if wrap_entire_card %}
        {% set ga_action_value = single_link.title|default(component_title|default('N/A'))|striptags|trim|e %}
        
        {# ACCESSIBILITY SYNTHESIS #}
        {% set aria_label_content %}
            {% if component_title %}{{ component_title|striptags|trim }}{% endif %}
            {% if single_link.title and single_link.title|striptags|trim != component_title|striptags|trim %}
                {% if component_title %} - {% endif %}{{ single_link.title|striptags|trim }}
            {% elseif not component_title %}
                {{ single_link.title|striptags|trim }}
            {% endif %}
        {% endset %}

        <a href="{{ single_link.url ?: '#' }}"
           class="card-link-wrapper d-block text-reset text-decoration-none"
           aria-label="{{ aria_label_content|trim|e }}"
           data-ga-event="card_click"
           data-ga-category="image_bundle"
           data-ga-action="{{ ga_action_value }}"
           data-ga-component-id="{{ unique_id }}">
    {% endif %}

        {# VISUAL TITLE: Respects the Drupal "Display Title" checkbox #}
        {% if label %}
            {% import '@cua_theme/component/macros/card_title.html.twig' as titleMacros %}
            {{ titleMacros.render_title(label, '', '', null, text_alignment, text_color, true, [], null, 3) }}
        {% endif %}

        {# MEDIA LAYER #}
        {% if card_image %}
            {% import '@cua_theme/component/macros/card_image.html.twig' as cardImageMacros %}
            <div class="image-wrap g-0 {{ text_alignment }} {{ padding }}">
                {{ cardImageMacros.render_card_image(card_image, image_size, content) }}
            </div>
        {% endif %}

        {# CAPTION LAYER #}
        {% if caption %}
            {% import '@cua_theme/component/macros/card_caption.html.twig' as captionMacros %}
            <div class="caption-wrap {{ text_alignment }} {{ padding }} {{ text_color }}">
                {{ captionMacros.render_caption(caption) }}
            </div>
        {% endif %}

        {# BODY CONTENT #}
        {% if content %}
            {% import '@cua_theme/component/macros/card_body.html.twig' as bodyMacros %}
            <div class="body-wrap px-5 pt-3 pb-2 {{ text_alignment }} {{ padding }}">
                {{ bodyMacros.render_body(content) }}
            </div>
        {% endif %}

        {# FOOTER AREA #}
        {% if links_count > 0 %}
            {% if wrap_entire_card %}
                {% set outline_class = outline ? 'btn-outline-' ~ button_color : 'btn-' ~ button_color %}
                <div class="card-footer d-flex justify-content-center align-items-center mb-3 border-0">
                    <span class="card-link btn {{ outline_class }} mx-auto p-2" aria-hidden="true">
                        {{ single_link.title ?: single_link.text ?: 'Read More'|t }}
                    </span>
                </div>
            {% else %}
                {% import '@cua_theme/component/macros/card_footer.html.twig' as cardFooterMacros %}
                {{ cardFooterMacros.render_card_footer(links, container_size, color_background, position_container, text_alignment, padding, outline, button_color, button_layout) }}
            {% endif %}
        {% endif %}

    {% if wrap_entire_card %}
        </a>
    {% endif %}
</div>