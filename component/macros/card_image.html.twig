{# 
  =============================================================================
  MACRO: render_card_image
  STABILITY: Production-Stable / Architecture: Sinn 103 (The Crystal)
  COMPLIANCE: Section 508 / WCAG 2.2 Level AA / Mobile UX Optimized
  =============================================================================
  TECHNICAL ARCHITECTURE:
  - Interaction: Supports the "Big Target" pattern by wrapping the image in 
    the card's primary URL if available.
  - Performance: Uses 'g-0' (no gutter) to ensure the image sits flush 
    against the card edges, maintaining the "Case" integrity.
  - A11Y: Prevents redundant link announcements via 'aria-hidden' and 
    'aria-label' mapping.

  MAINTENANCE WARNING:
  'card_image' expects a full Drupal render array or <img> tag. If passing 
  a background image, ensure 'role="img"' and 'aria-label' are added manually.
  =============================================================================
#}

{% macro render_card_image(
    card_image,
    position_container = null,
    text_alignment = null,
    text_color = null,
    image_size = null,
    image_text = null,
    content = null,
    hide_from_screen_readers = false,
    links = null
) %}

    {% if card_image %}

        {# 
           CONTAINER ORCHESTRATION:
           Leveraging Bootstrap's 'card-header' to anchor the media at 
           the top of the component stack.
        #}
        {% set card_image_classes = [
            'card-header',
            'border-0',
            'bg-transparent',
            position_container ? 'd-flex ' ~ position_container : null,
            text_alignment,
            text_color,
            image_size,
            'g-0'
        ] | filter(v => v) | join(' ') %}

        {# 
           MEDIA WRAPPER:
           Provides the hook for 'img-hover-effect' (e.g., zoom/brighten).
        #}
        {% set presentation_classes = [
            'card-img-wrapper',
            'overflow-hidden',
            image_size
        ] | filter(v => v) | join(' ') %}

        <div class="{{ card_image_classes }}">
            <div class="{{ presentation_classes }}">

                {# 
                   LINK LOGIC: 
                   If links exist, the image becomes an interactive "pusher".
                #}
                {% if links is not empty and links[0].url is defined %}
                    {% set firstLink = links[0] %}
                    <a class="img-hover-effect d-block" 
                       href="{{ firstLink.url|escape('html_attr') }}"
                       title="{{ firstLink.title|escape('html_attr') }}"
                       {% if hide_from_screen_readers %} aria-hidden="true" {% endif %}
                       aria-label="{{ firstLink.title|escape('html_attr') }}">
                        {{ card_image }}
                    </a>
                {% else %}
                    {# DECORATIVE / NON-INTERACTIVE IMAGE #}
                    <div class="img-static">
                        {{ card_image }}
                    </div>
                {% endif %}

            </div>
        </div>

    {% endif %}
{% endmacro %}