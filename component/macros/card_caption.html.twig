{# 
  =============================================================================
  MACRO: render_caption
  STABILITY: Production-Stable / Architecture: Sinn 556 iRS
  COMPLIANCE: Section 508 / WCAG 2.2 Level AA / HTML5 Semantic
  =============================================================================
  TECHNICAL ARCHITECTURE:
  - Semantics: Uses <figcaption> to provide a programmatic link to the parent 
    <figure> or image bundle, satisfying WCAG 1.3.1 (Info and Relationships).
  - Safety: Implements a 200-character word-safe "hard-stop" to protect the 
    vertical rhythm of the card layout.
  - A11Y: Explicitly labels the content as a caption for screen readers, 
    preventing any "What is this text?" ambiguity.

  MAINTENANCE WARNING:
  The truncation logic occurs *after* escaping and translation. If adding 
  HTML tags inside captions (e.g., <strong>), ensure the slice logic doesn't 
  break the closing tags. Currently optimized for plain-text strings.
  =============================================================================
#}

{% macro render_caption(caption, padding = 'p-3', text_color = null, text_alignment = null) %}
    {% if caption|trim %}
        {# 
           VALIDATION CONSTANTS:
           Standardized gaskets to ensure the CSS stays within theme specs.
        #}
        {% set _allowed = {
            padding: ['remove-padding', 'add-padding', 'p-0', 'p-3'],
            colors: ['cu-text-gold', 'cu-text-black', 'cu-text-white'],
            align: ['text-start', 'text-center', 'text-end']
        } %}

        {# Sanitization & Default Fallbacks #}
        {% set padding = padding in _allowed.padding ? padding : 'p-3' %}
        {% set text_color = text_color in _allowed.colors ? text_color : null %}
        {% set text_alignment = text_alignment in _allowed.align ? text_alignment : null %}

        {# 
           TRUNCATION ENGINE:
           Cuts at 200 chars but rolls back to the nearest space to avoid 
           splitting words. This is the "No-Lag" way to handle overflow.
        #}
        {% set max_length = 200 %}
        {% set processed_caption = caption|t|trim|e %}
        {% if processed_caption|length > max_length %}
            {% set processed_caption = processed_caption|slice(0, max_length)|split(' ')|slice(0, -1)|join(' ') ~ 'â€¦' %}
        {% endif %}

        {# CLASS ORCHESTRATION #}
        {% set caption_classes = [
            'card-caption',
            'px-3 py-2',
            'clearfix',
            padding,
            text_color,
            text_alignment
        ]|filter(v => v != null and v != '') %}

        {# 
           SEMANTIC OUTPUT:
           The visually-hidden span provides context for AT users, 
           while the figcaption provides the HTML5 landmark.
        #}
        <figcaption class="{{ caption_classes|join(' ') }}">
            <span class="visually-hidden">{{ 'Caption for image'|t }}</span>
            {{ processed_caption|e }}
        </figcaption>
    {% endif %}
{% endmacro %}