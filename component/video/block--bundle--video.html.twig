{# 
  =============================================================================
  COMPONENT: Accessible Video Hero / Section
  STABILITY: Production-Stable / Architecture: Sinn 556 iRS Equivalent (Complicated)
  COMPLIANCE: Section 508 / WCAG 2.2 Level AA / ADA Title II (Transcripts)
  =============================================================================
  TECHNICAL ARCHITECTURE:
  - Performance: Uses <link rel="preload"> for local MP4s to reduce LCP 
    (Largest Contentful Paint) lag.
  - Accessibility: Implements the "Transcript" pattern for users with 
    hearing impairments (WCAG 1.2.1).
  - Responsive: Dual-DOM rendering for desktop (parallax/absolute overlay) 
    vs mobile (stacked content) ensures high-contrast legibility.

  MAINTENANCE WARNING:
  The master video partial must ensure <iframe> elements contain a 'title' 
  attribute. 'aria-label' on iframes is often ignored by VoiceOver.
  =============================================================================
#}

{# Preload logic: The "No-Lag" start #}
{% if provider == 'local' and content.field_video_mp4.0 is defined %}
    {% set video_url = content.field_video_mp4.0['#url'] ?? content.field_video_mp4.0['#file'].url ?? null %}
    {% if video_url %}
        <link rel="preload" href="{{ video_url }}" as="video" type="video/mp4">
    {% endif %}
{% endif %}

{% import '@cua_theme/component/macros/card_title.html.twig' as titleMacros %}
{% import '@cua_theme/component/macros/card_body.html.twig' as bodyMacros %}
{% import '@cua_theme/component/macros/card_footer.html.twig' as cardFooterMacros %}

{{ attach_library('cua_theme/video') }}

{# ID ARCHITECTURE #}
{% set unique_id = 'video-' ~ elements.content['#block_content'].id()|replace({"_": "-", ":": "--"}) %}
{% set title_id = unique_id ~ '-label' %}

{# CLASS ORCHESTRATION #}
{% set video_classes = [
    'block video card g-0 clearfix',
    'block-' ~ configuration.provider|clean_class,
    margins ?: null,
    container_size ?: null,
    id ? 'block--' ~ id|replace({"_": "-"})|clean_class : '',
] %}

{# OUTER WRAPPER #}
<div{{ attributes
    .without('id')
    .setAttribute('id', unique_id)
    .addClass(video_classes)
    .setAttribute('role', 'region')
    .setAttribute('aria-labelledby', title_id)
}}>

    {{ title_prefix }}
    {{ title_suffix }}

    {# PROGRAMMATIC HEADING: Ensuring the landmark has a name #}
    <h3 id="{{ title_id }}" class="visually-hidden">
        {{ label ?: 'Video Content'|t }}
    </h3>

    {# VIDEO PLAYER: The "Movement" #}
    <div class="video-container {{ container_size }}">
        {% include '@cua_theme/component/video/partials/_video--master.html.twig' with {
            title_id: title_id,
            provider: provider,
            label: label,
        } %}
    </div>

    {# 
       TRANSCRIPT: 
       Critical for 508 compliance. sr-only-focusable ensures the link 
       only appears when the user tabs to it. 
    #}
    {% if transcript_url is defined %}
        <p class="sr-only-focusable mt-2">
            <a href="{{ transcript_url }}" class="btn btn-sm btn-light">
                <i class="fa-solid fa-file-lines me-1"></i> {{ 'Read video transcript'|t }}
            </a>
        </p>
    {% endif %}

    {# LAYOUT LAYERS #}
    {% if label or content %}
        
        {# DESKTOP OVERLAY #}
        <div class="video-desktop-copy d-none d-md-block g-0">
            <div class="container-fluid mx-auto {{ parallax_video ? 'parallax-main-content' : 'position-absolute' }} d-flex {{ position_container ?? '' }}">
                <div class="row">
                    <div class="col {{ color_background ?: '' }} px-5 py-4 m-5">
                        {{ titleMacros.render_title(label, title_prefix, title_suffix, center_content, text_alignment, text_color, padding, 'itemprop="name"') }}
                        {% if content %}{{ bodyMacros.render_body(content, padding, text_color, text_alignment) }}{% endif %}
                        {% if links|length %}{{ cardFooterMacros.render_card_footer(links, container_size, color_background, position_container, text_alignment, padding, outline, button_color, button_layout) }}{% endif %}
                    </div>
                </div>
            </div>
        </div>

        {# MOBILE STACKED #}
        <div class="video-mobile-copy d-md-none g-0 {{ parallax_video ? 'parallax-main-content' }}">
            <div class="container mt-0 mt-md-5">
                <div class="row">
                    <div class="col {{ color_background ?: '' }} p-3 my-5">
                        <div aria-hidden="true"> {# Hidden because the H3 at top handles the announcement #}
                            {{ titleMacros.render_title(label, title_prefix, title_suffix, center_content, text_alignment, text_color, padding, links, false, title_id) }}
                        </div>
                        {% if content %}{{ bodyMacros.render_body(content, padding, text_color, text_alignment) }}{% endif %}
                        {% if links|length %}{{ cardFooterMacros.render_card_footer(links, container_size, color_background, position_container, text_alignment, padding, outline, button_color, button_layout) }}{% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

</div>