{# Attach the CTA-specific library for styles and scripts #}
{{ attach_library('cua_theme/call-to-action') }}

{# Import title rendering macros #}
{% import '@cua_theme/component/macros/card_title.html.twig' as titleMacros %}

{# Generate a unique ID for the block, sanitized for CSS use #}
{% set unique_id = ('block-call-to-action-' ~ elements.content['#block_content'].id())|replace({'_': '-', ':': '--'})|clean_class %}

{# Build the class list for the CTA container, merging utility classes and filtering out nulls #}
{% set cta_classes = [
    'block',
    'block-' ~ configuration.provider|clean_class,
    'block-' ~ plugin_id|clean_class,
    'call-to-action',
    'card rounded-0',
    'h-100',
    animate_trigger,
    color_background ?: null,
    color_border ?: null,
    container_size ?: null,
    padding ?: null,
    margin ?: null,
    shadow ?: null,
    (animation or animation_speed or animation_delay) ? 'animate-trigger' : null,
    id ? 'block--class--call-to-action-' ~ id|clean_class : null,
] | merge(utility_classes ?: []) | filter(v => v) | join(' ') %}

{# Build animation classes unless reduced motion is preferred #}
{% set raw_animation_classes = prefers_reduced_motion ? [] : [
    'animate__animated',
    animation ?: null,
    animation_speed ?: null,
    animation_delay ?: null,
] | filter(v => v) %}
{% set data_animation_classes = raw_animation_classes|join(' ')|replace({'"': ''}) %}

{# Determine link context: single link and whether it wraps the card #}
{% set links_count = links|length %}
{% set single_link = (links_count == 1) ? links|first : null %}
{% set wrap_entire_card = single_link and not content_contains_other_links %}

{# Begin CTA container with semantic attributes and animation metadata #}
<div{{ attributes
| without('id')
    .setAttribute('id', unique_id)
    .addClass(cta_classes)
    .setAttribute('role', 'region')
    .setAttribute('aria-labelledby', unique_id ~ '-label')
    .setAttribute('data-animation-classes', data_animation_classes)
    .setAttribute('itemscope', '')
    .setAttribute('itemtype', 'https://schema.org/CreativeWork')
    .setAttribute('data-component', 'call-to-action-card')
}}>

    {# Render title prefix/suffix if present #}
    {{ title_prefix ?: '' }}
    {{ title_suffix ?: '' }}

    {# Hidden accessible label for screen readers #}
    {% if label %}
        <h3 id="{{ unique_id }}-label" class="sr-only visually-hidden">{{ label }}</h3>
    {% endif %}

    {# Wrap entire card in a link if there's only one and no other links in content #}
    {% if wrap_entire_card %}
    {% set ga_action_value = single_link.title|default(label|default('N/A'))|striptags|trim|e %}
    <a href="{{ single_link.url ?: '#' }}"
       class="cta-link"
            {% if single_link.title %}
                aria-label="{{ single_link.title|striptags|trim }}"
            {% endif %}
       data-ga-event="cta_click"
       data-ga-category="call_to_action"
       data-ga-action="{{ ga_action_value }}"
       data-ga-component-id="{{ unique_id }}">
        {% endif %}

        {# Optional flag rendering #}
        {% if flag %}
            {% import '@cua_theme/component/macros/card_flag.html.twig' as flagMacros %}
            {{ flagMacros.render_flag(flag, flag_title, icon, icon_size, flag_background) }}
        {% endif %}

        {# Media block: video, image, icon, or fallback #}
        <div class="cta-media">
            {% if provider %}
                {% include '@cua_theme/component/video/partials/_video--master.html.twig' %}
            {% elseif card_image %}
                {% import '@cua_theme/component/macros/card_image.html.twig' as cardImageMacros %}
                {{ cardImageMacros.render_card_image(
                    card_image,
                    position_container,
                    text_alignment,
                    text_color,
                    image_size,
                    visibility,
                    content,
                    true
                ) }}
            {% elseif icon %}
                {% import '@cua_theme/component/macros/card_icon.html.twig' as iconMacros %}
                {{ iconMacros.render_icon(
                    icon,
                    icon_size,
                    icon_color,
                    padding,
                    position_container,
                    text_alignment
                ) }}
            {% else %}
                <span class="cta-fallback" aria-hidden="true"></span>
            {% endif %}
        </div>

        {# Optional caption block #}
        {% if caption %}
            {% import '@cua_theme/component/macros/card_caption.html.twig' as captionMacros %}
            {{ captionMacros.render_caption(caption, padding, text_color, text_alignment) }}
        {% endif %}

        {# Visible heading if label is present #}
        {% if label %}
            {% set heading_classes = [
                'display-4 card-text lead title',
                text_alignment,
                center_content,
                text_color,
                padding,
            ] | filter(v => v) | join(' ') %}
            <h3 class="{{ heading_classes }}" aria-hidden="true">{{ label }}</h3>
        {% endif %}

        {# Main body content #}
        {% if content %}
            {% import '@cua_theme/component/macros/card_body.html.twig' as bodyMacros %}
            {{ bodyMacros.render_body(content, padding, text_color, text_alignment) }}
        {% endif %}

        {# Single link footer (non-wrapping) #}
        {% if single_link %}
            {% set outline_class = outline ? outline ~ 'btn-' ~ button_color : 'btn-' ~ button_color %}
            {% set card_footer_classes = [
                'card-footer',
                'd-flex',
                multiple_links ? 'multiple-links' : '',
                container_size,
                position_container,
                text_alignment,
                padding,
                'mb-5',
            ] | filter(v => v) | join(' ') %}
            {% set card_footer_link_classes = [
                'card-link',
                'btn',
                outline_class,
                'text-decoration-none',
                position_container,
                text_alignment,
                'p-2',
                'mt-3',
            ] | filter(v => v) | join(' ') %}
            <div class="{{ card_footer_classes }}">
                <span class="{{ card_footer_link_classes }}" aria-hidden="true">{{ single_link.title }}</span>
            </div>
        {% endif %}

        {# Multiple links footer (if not wrapping) #}
        {% if links and not wrap_entire_card %}
            {% import '@cua_theme/component/macros/card_footer.html.twig' as cardFooterMacros %}
            {{ cardFooterMacros.render_card_footer(
                links,
                container_size,
                color_background,
                position_container,
                text_alignment,
                padding,
                outline,
                button_color,
                button_layout,
                false,
                false
            ) }}
        {% endif %}

        {# Close wrapping link if opened earlier #}
        {% if wrap_entire_card %}
    </a>
    {% endif %}

</div>