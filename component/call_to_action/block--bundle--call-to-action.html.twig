{# 
  =============================================================================
  COMPONENT: Call to Action (CTA) Card
  STABILITY: Production-Stable / Architecture: Sinn 556 iRS Equivalent (No-Lag)
  COMPLIANCE: Section 508 / WCAG 2.2 Level AA / ADA Title II / Schema.org
  =============================================================================
  TECHNICAL ARCHITECTURE:
  - UX Logic: Implements a "Smart-Wrapper" pattern. If a single link exists 
    without content-level links, the entire card becomes the <a> for a larger 
    hit target (Fitts's Law optimization).
  - Tracking: Hard-coded GA4 data-attributes for precision event mapping.
  - A11Y: Supports 'prefers-reduced-motion' to prevent vestibular triggers 
    from heavy CSS animations.
  - SEO: Marked up as 'CreativeWork' via Schema.org microdata.

  MAINTENANCE WARNING:
  The GA4 'data-ga-action' value is auto-sanitized (|striptags|trim|e). 
  Modifying this filter may result in broken JSON strings in the analytics 
  datalayer if editors use special characters in titles.
  =============================================================================
#}

{# Asset Load: Centralized library management #}
{{ attach_library('cua_theme/call-to-action') }}

{# Macro Imports: Decoupled logic for Title, Flag, Image, Icon, and Body #}
{% import '@cua_theme/component/macros/card_title.html.twig' as titleMacros %}

{# 
  ID ARCHITECTURE:
  The ID is derived from the Block Content ID to ensure persistence 
  across cache clearsâ€”essential for anchor-linking and GA4 identification.
#}
{% set unique_id = ('block-cta-' ~ elements.content['#block_content'].id())|replace({'_': '-', ':': '--'})|clean_class %}

{# Utility Class Merging: Sinn-level precision in class management #}
{% set cta_classes = [
    'block',
    'block-' ~ configuration.provider|clean_class,
    'block-' ~ plugin_id|clean_class,
    'call-to-action card rounded-0 h-100',
    color_background ?: null,
    color_border ?: null,
    container_size ?: null,
    padding ?: null,
    margin ?: null,
    shadow ?: null,
    (animation or animation_speed or animation_delay) ? 'animate-trigger' : null,
    id ? 'block--class--cta-' ~ id|clean_class : null,
] | merge(utility_classes ?: []) | filter(v => v) | join(' ') %}

{# 
  ANIMATION LOGIC:
  Respects the user's OS-level accessibility settings. If 'Reduced Motion' 
  is enabled, the data-animation-classes attribute is zeroed out.
#}
{% set raw_animation_classes = prefers_reduced_motion ? [] : [
    'animate__animated',
    animation ?: null,
    animation_speed ?: null,
    animation_delay ?: null,
] | filter(v => v) %}
{% set data_animation_classes = raw_animation_classes|join(' ')|replace({'"': ''}) %}

{# Link Context Branching #}
{% set links_count = links|length %}
{% set single_link = (links_count == 1) ? links|first : null %}
{% set wrap_entire_card = single_link and not content_contains_other_links %}

{# 
  ATTRIBUTE ORCHESTRATION:
  We build the attribute object here to keep the <div> tag clean. 
  itemtype="CreativeWork" provides high-level SEO context for the contents.
#}
{% set attributes = attributes
    | without('id')
    .setAttribute('id', unique_id)
    .addClass(cta_classes)
    .setAttribute('role', 'region')
    .setAttribute('data-animation-classes', data_animation_classes)
    .setAttribute('itemscope', '')
    .setAttribute('itemtype', 'https://schema.org/CreativeWork')
    .setAttribute('data-component', 'call-to-action-card')
%}
{% if label %}
    {% set attributes = attributes.setAttribute('aria-labelledby', unique_id ~ '-label') %}
{% else %}
    {% set attributes = attributes.setAttribute('aria-label', 'Call to Action'|t) %}
{% endif %}

<div{{ attributes }}>

    {{ title_prefix }}
    {{ title_suffix }}

    {# 
       SR-ONLY TITLE: 
       Provides a semantic heading for screen readers without disrupting 
       the visual design. Uses visually-hidden for 508 compliance.
    #}
    {% if label %}
        <h3 id="{{ unique_id }}-label" class="sr-only visually-hidden">{{ label }}</h3>
    {% endif %}

    {# 
       SCENARIO A: WRAPPING LINK 
       This turns the entire card into a high-precision interactive hit zone.
    #}
    {% if wrap_entire_card %}
    {% set ga_action_value = single_link.title|default(label|default('N/A'))|striptags|trim|e %}
    <a href="{{ single_link.url ?: '#' }}"
       class="cta-link text-decoration-none"
            {% if single_link.title %}
                aria-label="{{ single_link.title|striptags|trim }}"
            {% endif %}
       data-ga-event="cta_click"
       data-ga-category="call_to_action"
       data-ga-action="{{ ga_action_value }}"
       data-ga-component-id="{{ unique_id }}">
    {% endif %}

        {# Conditional Flag Rendering #}
        {% if flag %}
            {% import '@cua_theme/component/macros/card_flag.html.twig' as flagMacros %}
            {{ flagMacros.render_flag(flag, flag_title, icon, icon_size, flag_background) }}
        {% endif %}

        {# Media Layer: Video > Image > Icon #}
        <div class="cta-media">
            {% if provider %}
                {% include '@cua_theme/component/video/partials/_video--master.html.twig' %}
            {% elseif card_image %}
                {% import '@cua_theme/component/macros/card_image.html.twig' as cardImageMacros %}
                {{ cardImageMacros.render_card_image(card_image, position_container, text_alignment, text_color, image_size, visibility, content, true) }}
            {% elseif icon %}
                {% import '@cua_theme/component/macros/card_icon.html.twig' as iconMacros %}
                {{ iconMacros.render_icon(icon, icon_size, icon_color, padding, position_container, text_alignment) }}
            {% else %}
                <span class="cta-fallback" aria-hidden="true"></span>
            {% endif %}
        </div>

        {# Optional Caption Block #}
        {% if caption %}
            {% import '@cua_theme/component/macros/card_caption.html.twig' as captionMacros %}
            {{ captionMacros.render_caption(caption, padding, text_color, text_alignment) }}
        {% endif %}

        {# 
           VISIBLE HEADING: 
           Set to aria-hidden="true" because the semantic <h3> above 
           already handles the screen reader announcement. 
        #}
        {% if label %}
            {% set heading_classes = ['display-4 card-text lead title', text_alignment, center_content, text_color, padding]|filter(v => v)|join(' ') %}
            <h3 class="{{ heading_classes }}" aria-hidden="true">{{ label }}</h3>
        {% endif %}

        {# Main Body Content #}
        {% if content %}
            {% import '@cua_theme/component/macros/card_body.html.twig' as bodyMacros %}
            {{ bodyMacros.render_body(content, padding, text_color, text_alignment) }}
        {% endif %}

        {# 
           FOOTER LOGIC: 
           If the card is wrapped in an <a> tag, we render a 'span' visual CTA 
           to avoid invalid HTML5 nested links.
        #}
        {% if single_link %}
            {% set outline_class = outline ? outline ~ 'btn-' ~ button_color : 'btn-' ~ button_color %}
            {% set card_footer_classes = ['card-footer d-flex mb-5', container_size, position_container, text_alignment, padding]|filter(v => v)|join(' ') %}
            
            <div class="{{ card_footer_classes }}">
                <span class="card-link btn {{ outline_class }} text-decoration-none p-2 mt-3" aria-hidden="true">
                    {{ single_link.title }}
                </span>
            </div>
        {% endif %}

        {# Multiple Links: Standard rendering (only if the card is NOT wrapped) #}
        {% if links and not wrap_entire_card %}
            {% import '@cua_theme/component/macros/card_footer.html.twig' as cardFooterMacros %}
            {{ cardFooterMacros.render_card_footer(links, container_size, color_background, position_container, text_alignment, padding, outline, button_color, button_layout, false, false) }}
        {% endif %}

    {% if wrap_entire_card %}
    </a>
    {% endif %}

</div>