{# 
  =============================================================================
  COMPONENT: Statistics Counter
  STABILITY: Production-Stable / Architecture: Sinn 556 iRS Equivalent (No-Lag)
  COMPLIANCE: Section 508 / WCAG 2.2 Level AA / GA4 Event Hardened
  =============================================================================
  TECHNICAL ARCHITECTURE:
  - Animation: Optimized for 'CounterUp' JS or similar library hooks via 
    the 'cua_theme/counter' library.
  - Accessibility: Robust landmark naming strategy prevents 'orphan' regions 
    in the accessibility tree.
  - Tracking: Explicit GA4 attributes injected into action triggers.

  MAINTENANCE WARNING:
  The ID generation uses elements.content['#block_content'].id(). If manually 
  placing this block in code (e.g., via a controller), ensure a fallback 
  ID is provided to prevent JS counter initialization failures.
  =============================================================================
#}

{{ attach_library('cua_theme/counter') }}

{# Macro Imports: Centralized logic for UI consistency #}
{% import '@cua_theme/component/macros/card_title.html.twig' as titleMacros %}
{% import '@cua_theme/component/macros/card_counter.html.twig' as counterMacros %}

{# 
  UTILITY CLASS MERGING: 
  Sinn-standard precision. We merge 'card' and 'rounded-0' to maintain 
  the specific aesthetic of the University design system.
#}
{% set counter_classes = [
    'block',
    'block-' ~ configuration.provider|clean_class,
    'counter card rounded-0 mx-2 p-3',
    color_background ?: null,
    color_border ?: null,
    container_size ?: null,
    id ? 'block--' ~ id|replace({'_': '-'})|clean_class : null
] | merge(utility_classes|default([])) | filter(v => v) | join(' ') %}

{% set unique_id = 'counter-' ~ elements.content['#block_content'].id()|default(random(1000)) %}
{% set title_id = unique_id ~ '-title' %}

{# 
  ATTRIBUTE ORCHESTRATION:
  We set role="region" to ensure statistics are easily locatable 
  via screen reader 'Landmark' navigation.
#}
{% set attributes = attributes
    | without('id')
    .setAttribute('id', unique_id)
    .addClass(counter_classes)
    .setAttribute('role', 'region')
%}

{# 
  LANDMARK STRATEGY: 
  If the label is visible, link to it. If not, provide a text string. 
  This prevents 'Broken ARIA Reference' errors in Lighthouse.
#}
{% if label and not hide_from_screen_readers %}
    {% set attributes = attributes.setAttribute('aria-labelledby', title_id) %}
{% else %}
    {% set attributes = attributes.setAttribute('aria-label', (label ?: 'Counter'|t)|striptags|trim) %}
{% endif %}

<div{{ attributes }}>

    {# TITLE LAYER: Calibrated with the title_id for ARIA binding #}
    {{ titleMacros.render_title(label, title_prefix, title_suffix, center_content, text_alignment, text_color, padding, hide_from_screen_readers, links, title_id) }}

    {# MEDIA LAYER: Mutually exclusive branching for visual assets #}
    {% if card_image %}
        {% import '@cua_theme/component/macros/card_image.html.twig' as cardImageMacros %}
        {{ cardImageMacros.render_card_image(card_image, position_container, text_alignment, text_color, image_size, visibility, content, links) }}
    {% elseif icon %}
        {% import '@cua_theme/component/macros/card_icon.html.twig' as iconMacros %}
        {{ iconMacros.render_icon(icon, icon_size, icon_color, padding, position_container, text_alignment, 'Counter visual icon'|t) }}
    {% endif %}

    {# 
       COUNTER DISPLAY: 
       The main movement. This macro handles the <span> wrappers 
       required for the JS 'count-up' effect.
    #}
    {{ counterMacros.render_counter(number, text_alignment, text_color, before_number, after_number) }}

    {# BODY LAYER: Contextual description of the statistic #}
    {% if content %}
        {% import '@cua_theme/component/macros/card_body.html.twig' as bodyMacros %}
        {{ bodyMacros.render_body(content, padding, text_color, text_alignment) }}
    {% endif %}

    {# 
       FOOTER / CTA LAYER: 
       Scenario-based rendering to ensure GA4 tracking precision.
    #}
    {% if links %}
        {% import '@cua_theme/component/macros/card_footer.html.twig' as cardFooterMacros %}

        {% if links|length == 1 and not content_contains_other_links %}
            {# SCENARIO 1: SINGLE LINK - Manual Hammer for GA4 accuracy #}
            {% set first_link = links|first %}
            {% set outline_class = outline ? outline ~ 'btn-' ~ button_color : 'btn-' ~ button_color %}
            {% set link_classes = ['card-link btn', outline_class, 'text-decoration-none p-2 mt-3']|filter(v => v)|join(' ') %}

            <div class="card-footer d-flex container mb-5">
                <a href="{{ first_link.url ?: '#' }}"
                   class="{{ link_classes }}"
                   data-ga-event="counter_cta"
                   data-ga-category="counter"
                   data-ga-action="{{ first_link.title|default(label)|striptags|trim|e }}"
                   data-ga-component-id="{{ unique_id }}">
                    {{ first_link.title|default('Learn More'|t) }}
                </a>
            </div>
        {% else %}
            {# SCENARIO 2: MULTIPLE LINKS - Macro fallback #}
            {% set ga_attributes = {
                'data-ga-event': 'counter_cta',
                'data-ga-category': 'counter',
                'data-ga-component-id': unique_id
            } %}
            {{ cardFooterMacros.render_card_footer(links, container_size, color_background, position_container, text_alignment, padding, outline, button_color, button_layout, false, false, ga_attributes) }}
        {% endif %}
    {% endif %}

</div>